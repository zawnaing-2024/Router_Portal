{% extends 'base.html' %}
{% block content %}
<h3>Pings</h3>
<script>
  async function refreshPings() {
    try {
      const res = await fetch('/api/pings', { cache: 'no-store' });
      const data = await res.json();
      for (const row of data) {
        const rttEl = document.querySelector(`[data-rtt="${row.id}"]`);
        const timeEl = document.querySelector(`[data-time="${row.id}"]`);
        if (rttEl) rttEl.textContent = row.last_rtt_ms != null ? row.last_rtt_ms.toFixed(1) : '-';
        if (timeEl) timeEl.textContent = row.last_checked_at_display ? row.last_checked_at_display + ' MMT' : '-';
      }
    } catch {}
    setTimeout(refreshPings, 1000);
  }
  refreshPings();
  // Updates only the relevant cells every 1s without reloading the page
  </script>
<div class="row">
  <div class="col-md-5">
    <h5>Add Ping Monitor</h5>
    <form method="post" class="card card-body mb-4">
      <div class="mb-2">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Target IP</label>
        <input type="text" name="target_ip" class="form-control" placeholder="8.8.8.8" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Source IP (optional)</label>
        <input type="text" name="source_ip" class="form-control" placeholder="192.168.1.1">
      </div>
      <div class="mb-2">
        <label class="form-label">Source Interface (optional)</label>
        <input type="text" name="source_interface" class="form-control" placeholder="ether1">
      </div>
      <div class="mb-3">
        <label class="form-label">Router</label>
        <select name="device_id" class="form-select" required>
          <option value="">Select device...</option>
          {% for d in devices %}
          <option value="{{ d.id }}">{{ d.name }} ({{ d.host }})</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn btn-primary" type="submit">Add Monitor</button>
    </form>
  </div>
  <div class="col-md-7">
    <h5>Monitors</h5>
    <div class="mb-2 p-2 border rounded">
      <form class="row g-2 align-items-end" onsubmit="event.preventDefault(); loadChart();">
        <div class="col-auto">
          <label class="form-label">Monitor</label>
          <select id="chartCheckId" class="form-select form-select-sm">
            {% for r in rows %}
            <option value="{{ r.id }}">{{ r.name }} ({{ r.target_ip }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label">Since</label>
          <select id="sinceSeconds" class="form-select form-select-sm">
            <option value="60">1 min</option>
            <option value="300">5 min</option>
            <option value="900">15 min</option>
            <option value="3600">1 hour</option>
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-sm btn-outline-primary" type="submit">Apply</button>
        </div>
        <div class="col-auto">
          <small id="pingLastUpdate" class="text-muted align-self-center">Last update: -</small>
        </div>
      </form>
      <div class="mt-2" style="height: 200px;">
        <canvas id="pingChart"></canvas>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Target IP</th>
            <th>Source</th>
            <th>Router</th>
            <th>Result (ms)</th>
            <th>Last Checked</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.name }}</td>
            <td>{{ r.target_ip }}</td>
            <td>{{ r.source }}</td>
            <td>{{ r.device_name }}</td>
            <td data-rtt="{{ r.id }}">{% if r.last_rtt_ms is not none %}{{ '%.1f'|format(r.last_rtt_ms) }}{% else %}-{% endif %}</td>
            <td data-time="{{ r.id }}">{% if r.last_checked_at %}{{ r.last_checked_at|yangon_time }} MMT{% else %}-{% endif %}</td>
            <td>
              <div class="btn-group" role="group">
                <a href="{{ url_for('edit_ping', check_id=r.id) }}" class="btn btn-sm btn-outline-secondary me-1">Edit</a>
                <form method="post" action="{{ url_for('notify_ping', check_id=r.id) }}" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary me-1">Send</button>
                </form>
                <form method="post" action="{{ url_for('delete_ping', check_id=r.id) }}" onsubmit="return confirm('Delete monitor {{ r.name }}?');" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<script>
  let pingChart;
  let pingUpdateInterval;

  async function loadChart() {
    const idEl = document.getElementById('chartCheckId');
    if (!idEl || !idEl.value) return;

    const checkId = idEl.value;
    const since = document.getElementById('sinceSeconds').value;

    try {
      const res = await fetch(`/api/pings/samples?check_id=${checkId}&since_seconds=${since}`, {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (!res.ok) {
        console.error('Failed to fetch ping data:', res.status);
        return;
      }

      const points = await res.json();
      if (points.error) {
        console.error('API Error:', points.error);
        return;
      }

      const labels = points.map(p => p.ts);
      const data = points.map(p => p.rtt_ms);

      if (!pingChart) {
        const ctx = document.getElementById('pingChart').getContext('2d');
        pingChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'RTT (ms)',
              data: data,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              tension: 0.2,
              pointRadius: 0,
              fill: false
            }]
          },
          options: {
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'second',
                  displayFormats: {
                    second: 'HH:mm:ss'
                  }
                },
                title: {
                  display: true,
                  text: 'Time (MMT)'
                },

              },
              y: {
                title: {
                  display: true,
                  text: 'Response Time (ms)'
                },
                beginAtZero: true
              }
            },
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            }
          }
        });
      } else {
        pingChart.data.labels = labels;
        pingChart.data.datasets[0].data = data;
        pingChart.update('none');
      }

      // Update last update timestamp using server time (get from response or calculate)
      const now = new Date();
      // Get the latest data timestamp to show consistent time
      const latestTimestamp = points.length > 0 ? new Date(points[points.length - 1].ts) : now;

      // Display in Asia/Yangon timezone
      const options = {
        hour12: false,
        timeZone: 'Asia/Yangon',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };

      document.getElementById('pingLastUpdate').textContent =
        'Last update: ' + latestTimestamp.toLocaleString('en-US', options);

    } catch (error) {
      console.error('Error loading ping chart:', error);
    }
  }

  function startPingUpdates() {
    // Clear any existing interval
    if (pingUpdateInterval) {
      clearInterval(pingUpdateInterval);
    }
    // Start new interval - update every 1 second to match data collection
    pingUpdateInterval = setInterval(loadChart, 1000);
  }

  // Initial load
  loadChart();

  // Start regular updates
  startPingUpdates();

  // Restart updates when monitor selection changes
  document.getElementById('chartCheckId')?.addEventListener('change', function() {
    loadChart();
    startPingUpdates();
  });

  document.getElementById('sinceSeconds')?.addEventListener('change', function() {
    loadChart();
  });
</script>
{% endblock %}
