{% extends 'base.html' %}
{% block content %}
<h3>Fiber Monitors</h3>
<div class="row">
  <div class="col-md-5">
    <h5>Add Monitor</h5>
    <form method="post" class="card card-body mb-3">
      <div class="mb-2">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Interface (e.g., sfp1)</label>
        <input type="text" name="if_name" class="form-control" placeholder="sfp1" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Router</label>
        <select name="device_id" class="form-select" required>
          <option value="">Select device...</option>
          {% for d in devices %}
          <option value="{{ d.id }}">{{ d.name }} ({{ d.host }})</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn btn-primary">Add</button>
    </form>
  </div>
  <div class="col-md-7">
    <h5>Monitors</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Router</th>
            <th>Interface</th>
            <th>Rx (dBm)</th>
            <th>Tx (dBm)</th>
            <th>Oper</th>
            <th>Last</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.name }}</td>
            <td>{{ r.device_name }}</td>
            <td>{{ r.if_name }}</td>
            <td>{{ r.rx if r.rx is not none else '-' }}</td>
            <td>{{ r.tx if r.tx is not none else '-' }}</td>
            <td>{% if r.oper == 1 %}<span class="badge text-bg-success">up</span>{% elif r.oper == 2 %}<span class="badge text-bg-danger">down</span>{% else %}-{% endif %}</td>
            <td>{% if r.ts %}{{ r.ts|yangon_time }} MMT{% else %}-{% endif %}</td>
            <td>
              <div class="btn-group" role="group">
                <a href="{{ url_for('edit_fiber', check_id=r.id) }}" class="btn btn-sm btn-outline-secondary me-1">Edit</a>
                <form method="post" action="{{ url_for('fiber_probe', check_id=r.id) }}" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary me-1">Probe</button>
                </form>
                <form method="post" action="{{ url_for('delete_fiber', check_id=r.id) }}" class="d-inline" onsubmit="return confirm('Delete fiber monitor {{ r.name }}?');">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3 p-2 border rounded">
      <form class="row g-2 align-items-end" onsubmit="event.preventDefault(); loadFiberChart();">
        <div class="col-auto">
          <label class="form-label">Monitor</label>
          <select id="fiberCheckId" class="form-select form-select-sm">
            {% for r in rows %}
            <option value="{{ r.id }}">{{ r.name }} ({{ r.if_name }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label">Since</label>
          <select id="fiberSince" class="form-select form-select-sm">
            <option value="600">10 min</option>
            <option value="3600">1 hour</option>
            <option value="21600">6 hours</option>
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-sm btn-outline-primary">Apply</button>
        </div>
        <div class="col-auto">
          <small id="fiberLastUpdate" class="text-muted align-self-center">Last update: -</small>
        </div>
      </form>
      <div class="mt-2" style="height: 220px;">
        <canvas id="fiberChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<script>
  let fiberChart;
  let fiberUpdateInterval;

  async function loadFiberChart() {
    const id = document.getElementById('fiberCheckId')?.value;
    if (!id) return;

    const since = document.getElementById('fiberSince').value;
    try {
      const res = await fetch(`/api/fibers/samples?check_id=${id}&since_seconds=${since}`, {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (!res.ok) {
        console.error('Failed to fetch fiber data:', res.status);
        return;
      }

      const pts = await res.json();
      if (pts.error) {
        console.error('API Error:', pts.error);
        return;
      }

      const labels = pts.map(p => p.ts);
      const rx = pts.map(p => p.rx);
      const tx = pts.map(p => p.tx);

      if (!fiberChart) {
        const ctx = document.getElementById('fiberChart').getContext('2d');
        fiberChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Rx (dBm)',
                data: rx,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.2,
                pointRadius: 0,
                fill: false
              },
              {
                label: 'Tx (dBm)',
                data: tx,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.2,
                pointRadius: 0,
                fill: false
              }
            ]
          },
          options: {
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  displayFormats: {
                    minute: 'HH:mm:ss'
                  }
                },
                title: {
                  display: true,
                  text: 'Time (MMT)'
                },

              },
              y: {
                title: {
                  display: true,
                  text: 'Power (dBm)'
                },
                beginAtZero: false
              }
            },
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            }
          }
        });
      } else {
        fiberChart.data.labels = labels;
        fiberChart.data.datasets[0].data = rx;
        fiberChart.data.datasets[1].data = tx;
        fiberChart.update('none');
      }

      // Update last update timestamp using server time (get from response or calculate)
      const now = new Date();
      // Get the latest data timestamp to show consistent time
      const latestTimestamp = pts.length > 0 ? new Date(pts[pts.length - 1].ts) : now;

      // Display in Asia/Yangon timezone
      const options = {
        hour12: false,
        timeZone: 'Asia/Yangon',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };

      document.getElementById('fiberLastUpdate').textContent =
        'Last update: ' + latestTimestamp.toLocaleString('en-US', options);

    } catch (error) {
      console.error('Error loading fiber chart:', error);
    }
  }

  function startFiberUpdates() {
    // Clear any existing interval
    if (fiberUpdateInterval) {
      clearInterval(fiberUpdateInterval);
    }
    // Start new interval - update every 60 seconds to match data collection
    fiberUpdateInterval = setInterval(loadFiberChart, 60000);
  }

  // Initial load
  loadFiberChart();

  // Start regular updates
  startFiberUpdates();

  // Restart updates when monitor selection changes
  document.getElementById('fiberCheckId')?.addEventListener('change', function() {
    loadFiberChart();
    startFiberUpdates();
  });

  document.getElementById('fiberSince')?.addEventListener('change', function() {
    loadFiberChart();
  });
</script>
{% endblock %}


